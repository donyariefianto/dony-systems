<!DOCTYPE html>
<html lang="id">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>
   Grid Dashboard Test Bench
  </title>

  <script src="https://cdn.tailwindcss.com">

  </script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js">

  </script>
  <script src="https://cdn.jsdelivr.net/npm/echarts-gl@2.0.9/dist/echarts-gl.min.js">

  </script>
  <link
   rel="stylesheet"
   href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <style>
   /* Transisi halus untuk efek fullscreen */
   
   .widget-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
   }
   
   /* State Fullscreen */
   
   .widget-card.is-fullscreen {
    position: fixed;
    inset: 0;
    z-index: 50;
    width: 100vw;
    height: 100vh;
    border-radius: 0;
    margin: 0;
   }
   
   /* Hide scrollbar for cleaner look */
   
   .no-scrollbar::-webkit-scrollbar {
    display: none;
   }
   
   .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
   }
  </style>
 </head>
 <body class="bg-slate-100 text-slate-800 min-h-screen flex flex-col font-sans">

  <header
   class="bg-white border-b px-6 py-3 flex justify-between items-center sticky top-0 z-40 shadow-sm"
  >
   <div class="flex items-center gap-3">
    <div
     class="w-9 h-9 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-indigo-200"
    >
     <i class="fas fa-layer-group"></i>
    </div>
    <div>
     <h1 class="font-bold text-lg leading-none text-slate-800">
      Dashboard Grid Test
     </h1>
     <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
      WebGL Renderer Debugger
     </p>
    </div>
   </div>
   <button
    onclick="renderAllWidgets()"
    class="px-4 py-2 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 rounded-lg text-xs font-bold transition flex items-center gap-2"
   >
    <i class="fas fa-sync-alt"></i>Reload All
        </button>
  </header>

  <main class="flex-1 p-6 overflow-y-auto">
   <div
    id="dashboard-grid"
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto"
   >
   </div>
  </main>

  <div
   id="console-log"
   class="fixed bottom-0 left-0 right-0 h-32 bg-slate-900/95 text-green-400 font-mono text-[10px] p-4 overflow-y-auto no-scrollbar border-t border-slate-700 z-[100] transition-transform translate-y-24 hover:translate-y-0 opacity-90 hover:opacity-100"
  >
   <div class="text-white border-b border-slate-700 pb-1 mb-2 font-bold flex justify-between">
    <span>> SYSTEM LOGS (Hover to expand)</span>
    <span
     onclick="document.getElementById('console-log').innerHTML=''"
     class="cursor-pointer hover:text-red-400"
    >CLEAR</span>
   </div>
  </div>

  <script>
   // ==========================================
   // 1. DATA MOCK (Widget Scenarios)
   // ==========================================
   const widgetsData = [ {
    id: "widget_1",
    title: "3D Surface Math",
    icon: "fa-chart-area",
    subtype: "surface",
    is3D: true,
    desc: "Testing Equation Restoration",
    // Simulasi: function hilang di JSON
    echartsOptions: {
     grid3D: {
      viewControl: {
       autoRotate: true
      }
     },
     series: [ {
      type: "surface",
      equation: {
       z: "broken_function"
      }
     } ]
    },
    data: []
   }, {
    id: "widget_2",
    title: "3D Bar Dataset",
    icon: "fa-cubes",
    subtype: "bar3D",
    is3D: true,
    desc: "Testing 3D Data Injection",
    echartsOptions: {},
    data: [ [ 0, 0, 5 ], [ 1, 0, 8 ], [ 2, 0, 4 ], [ 0, 1, 6 ], [ 1, 1, 2 ], [ 2, 1, 9 ], [ 0, 2, 4 ], [ 1, 2, 6 ] ]
   }, {
    id: "widget_3",
    title: "Radar Competency",
    icon: "fa-spider",
    subtype: "radar",
    is3D: false,
    desc: "Testing Radar Indicator Fix",
    echartsOptions: {},
    data: [ {
     value: [ 80, 50, 40, 90, 60 ],
     name: "Team A"
    } ]
   }, {
    id: "widget_4",
    title: "Sales Mixed Chart",
    icon: "fa-chart-bar",
    subtype: "mixed",
    is3D: false,
    desc: "Testing Dual Axis",
    echartsOptions: {},
    data: [ {
     label: "Jan",
     value: 120,
     trend: 15
    }, {
     label: "Feb",
     value: 200,
     trend: 25
    }, {
     label: "Mar",
     value: 150,
     trend: 18
    }, {
     label: "Apr",
     value: 80,
     trend: 10
    } ]
   }, {
    id: "widget_5",
    title: "Scatter Distribution",
    icon: "fa-braille",
    subtype: "scatter",
    is3D: false,
    desc: "Testing Value Axis",
    echartsOptions: {},
    data: [ [ 10, 20 ], [ 15, 25 ], [ 20, 10 ], [ 35, 40 ], [ 50, 30 ] ]
   }, {
    id: "widget_6",
    title: "3D Surface (Variant)",
    icon: "fa-mountain",
    subtype: "surface",
    is3D: true,
    desc: "Checking Multiple 3D Instances",
    echartsOptions: {
     visualMap: {
      inRange: {
       color: [ "#fff", "#000" ]
      }
     }
    },
    data: []
   } ];
   // ==========================================
   // 2. HELPER: LOGGER
   // ==========================================

   function log(msg, type = "info") {
    const el = document.getElementById("console-log");
    const color = type === "error" ? "text-red-400" : type === "warn" ? "text-yellow-400" : "text-green-400";
    const time = new Date().toLocaleTimeString().split(" ")[0];
    const div = document.createElement("div");
    div.className = `${color} font-mono`;
    div.innerHTML = `[${time}] ${msg}`;
    el.appendChild(div);
    el.scrollTop = el.scrollHeight;
   }
   // ==========================================
   // 3. CORE LOGIC (FUNGSI INIT YANG DIUJI)
   // ==========================================

   async function initChartWidget(containerId, widget, data, isFullscreen = false, attempt = 0) {
    const chartDom = document.getElementById(containerId);
    if (!chartDom) return;
    // A. DOM POLLING (WAIT FOR LAYOUT)
    let width = chartDom.clientWidth;
    let height = chartDom.clientHeight;
    if (height === 0) {
     if (attempt < 15) {
      setTimeout(() => initChartWidget(containerId, widget, data, isFullscreen, attempt + 1), 100);
      return;
     }
     log(`[${containerId}] Force Height applied (Fallback)`, "warn");
     height = 300;
     chartDom.style.height = "300px";
    }
    try {
     // B. LOAD LIBRARY & DISPOSE
     const subtype = widget.subtype || "bar";
     const is3D = widget.is3D || subtype.includes("3D") || widget.type === "surface";
     const oldInstance = echarts.getInstanceByDom(chartDom);
     if (oldInstance) oldInstance.dispose();
     // C. INIT DENGAN UKURAN EKSPLISIT
     const myChart = echarts.init(chartDom, null, {
      width: width || "auto",
      height: height || "auto"
     });
     // D. BUILD OPTION
     let option = {
      backgroundColor: "transparent",
      tooltip: {
       trigger: "item"
      },
      ...widget.echartsOptions
     };
     if (!option.series || option.series.length === 0) option.series = [ {
      type: subtype
     } ];
     // E. LOGIKA PERBAIKAN DATA (LOGIC INTI)
     if (subtype === "surface") {
      // FIX SURFACE: HAPUS DATA, PAKSA EQUATION
      delete option.series[0].data;
      // RE-HYDRATE FUNCTION
      if (!option.series[0].equation || typeof option.series[0].equation.z !== "function") {
       option.series[0].equation = {
        x: {
         step: .05,
         min: -3,
         max: 3
        },
        y: {
         step: .05,
         min: -3,
         max: 3
        },
        z: function(x, y) {
         return Math.sin(x * x + y * y) * x / 3.14;
        }
       };
      }
      // FIX VISUALS
      if (!option.visualMap) option.visualMap = {
       show: false,
       dimension: 2,
       min: -1,
       max: 1,
       inRange: {
        color: [ "#313695", "#d73027" ]
       }
      };
      if (!option.xAxis3D) option.xAxis3D = {
       type: "value"
      };
      if (!option.yAxis3D) option.yAxis3D = {
       type: "value"
      };
      if (!option.zAxis3D) option.zAxis3D = {
       type: "value"
      };
      if (!option.grid3D) option.grid3D = {
       viewControl: {
        autoRotate: true
       }
      };
      option.series[0].shading = "realistic";
     } else if (is3D) {
      // GENERIC 3D
      if (!option.grid3D) option.grid3D = {
       viewControl: {
        autoRotate: true
       }
      };
      if (!option.xAxis3D) option.xAxis3D = {
       type: "category"
      };
      if (!option.yAxis3D) option.yAxis3D = {
       type: "category"
      };
      if (!option.zAxis3D) option.zAxis3D = {
       type: "value"
      };
      option.series[0].data = data;
     } else if ([ "bar", "line", "mixed" ].includes(subtype)) {
      // 2D STANDARD
      const labels = data.map(d => d.label || "-");
      const vals = data.map(d => d.value || 0);
      if (subtype === "mixed") {
       option.series = [ {
        type: "bar",
        data: vals,
        name: "Main"
       }, {
        type: "line",
        data: data.map(d => d.trend || 0),
        yAxisIndex: 1,
        name: "Trend"
       } ];
       option.yAxis = [ {
        type: "value"
       }, {
        type: "value",
        splitLine: {
         show: false
        }
       } ];
       option.xAxis = {
        type: "category",
        data: labels
       };
      } else {
       option.series[0].data = vals;
       if (!option.xAxis) option.xAxis = {
        type: "category",
        data: labels
       };
       if (!option.yAxis) option.yAxis = {
        type: "value"
       };
      }
     } else if (subtype === "radar") {
      if (!option.radar) option.radar = {
       indicator: [ {
        name: "A"
       }, {
        name: "B"
       }, {
        name: "C"
       }, {
        name: "D"
       }, {
        name: "E"
       } ]
      };
      option.series[0].data = data;
     } else {
      option.series[0].data = data;
     }
     // F. RENDER
     myChart.setOption(option);
     log(`${containerId} rendered successfully.`, "success");
     // Cleanup Forced Height
     if (chartDom.style.height === "300px") {
      setTimeout(() => {
       chartDom.style.height = "";
       myChart.resize();
      }, 200);
     }
     // Event Listener untuk Resize otomatis
     window.addEventListener("resize", () => myChart.resize());
     // Simpan instance di DOM untuk akses nanti
     chartDom._echartsInstance = myChart;
    } catch (err) {
     log(`Error ${containerId}: ${err.message}`, "error");
    }
   }
   // ==========================================
   // 4. UI LOGIC (GRID RENDERING)
   // ==========================================

   function renderAllWidgets() {
    const grid = document.getElementById("dashboard-grid");
    grid.innerHTML = "";
    document.getElementById("console-log").innerHTML = "<div>> Starting Grid Render...</div>";
    widgetsData.forEach((widget, index) => {
     const chartId = `chart-${widget.id}`;
     const cardId = `card-${widget.id}`;
     // A. Create HTML Card
     const card = document.createElement("div");
     card.id = cardId;
     card.className = "widget-card bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[300px] relative hover:shadow-md hover:border-indigo-300";
     card.innerHTML = `
                                                                                                                                                                                                                                                                                                                                                                                                                                                     <div class="px-5 py-4 border-b border-slate-50 flex justify-between items-center bg-white z-10">
                                                                                                                                                                                                                                                                                                                                                                                                                                                         <div class="flex items-center gap-3">
                                                                                                                                                                                                                                                                                                                                                                                                                                                             <div class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center text-xs">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <i class="fas ${widget.icon}"></i>
                                                                                                                                                                                                                                                                                                                                                                                                                                                             </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                             <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <h3 class="font-bold text-slate-700 text-xs uppercase tracking-tight">${widget.title}</h3>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <p class="text-[10px] text-slate-400">${widget.subtype}</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                             </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                         </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                         <button onclick="toggleFullscreen('${widget.id}')" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-slate-100 text-slate-400 hover:text-indigo-600 transition">
                                                                                                                                                                                                                                                                                                                                                                                                                                                             <i id="icon-${widget.id}" class="fas fa-expand"></i>
                                                                                                                                                                                                                                                                                                                                                                                                                                                         </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                     </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                     <div class="flex-1 relative bg-slate-50/50 overflow-hidden">
                                                                                                                                                                                                                                                                                                                                                                                                                                                         <div id="${chartId}" class="w-full h-full absolute inset-0"></div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                     </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                 `;
     grid.appendChild(card);
     // B. Init Chart (Delayed)
     setTimeout(() => {
      initChartWidget(chartId, widget, widget.data);
     }, 100 + index * 50); // Staggered loading
    });
   }
   // ==========================================
   // 5. FULLSCREEN LOGIC
   // ==========================================

   function toggleFullscreen(widgetId) {
    const card = document.getElementById(`card-${widgetId}`);
    const icon = document.getElementById(`icon-${widgetId}`);
    const chartId = `chart-${widgetId}`;
    const chartDom = document.getElementById(chartId);
    // Toggle CSS Class
    card.classList.toggle("is-fullscreen");
    const isFull = card.classList.contains("is-fullscreen");
    // Ubah Icon
    icon.className = isFull ? "fas fa-compress" : "fas fa-expand";
    // PENTING: Resize Chart
    // Kita tunggu transisi CSS (300ms) selesai baru resize chart
    log(`Toggling Fullscreen for ${widgetId}...`);
    setTimeout(() => {
     if (chartDom && chartDom._echartsInstance) {
      chartDom._echartsInstance.resize();
      log("Chart resized to new dimensions.", "success");
     }
    }, 350);
   }
   // Auto Run on Load

   renderAllWidgets();
  </script>
 </body>
</html>
